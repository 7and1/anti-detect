name = "anti-detect-api"
main = "src/index.ts"
compatibility_date = "2024-01-01"
compatibility_flags = ["nodejs_compat"]

# Environment variables (default/development)
[vars]
ENVIRONMENT = "development"
CORS_ORIGIN = "http://localhost:3000"
TURNSTILE_SITE_KEY = "0x4AAAAAAA..." # Replace with your Cloudflare Turnstile site key
WEBHOOK_SIGNING_SECRET = "local-dev-signing-key"
API_KEYS = "dev-api-key"

# NOTE: TURNSTILE_SECRET should be set via wrangler secret:
# wrangler secret put TURNSTILE_SECRET
# This keeps the secret out of version control

# D1 Database
[[d1_databases]]
binding = "DB"
database_name = "anti-detect"
database_id = "d19c7a11-4ae5-4bef-bd65-05a2133a5371"

# KV Namespaces
[[kv_namespaces]]
binding = "IP_CACHE"
id = "06d882d1a9a946dbaf6204a542d5df58"

[[kv_namespaces]]
binding = "JA3_DB"
id = "6a013dac92704342a9f59317eabe956d"

[[kv_namespaces]]
binding = "RATE_LIMITS"
id = "d8a25b02d2d248e3bdc81e9fd6af67b3"

[[kv_namespaces]]
binding = "TASK_QUEUE"
id = "4e012345678901234567890123456789"

# R2 Bucket
[[r2_buckets]]
binding = "R2"
bucket_name = "anti-detect-reports"

# Cron triggers
[triggers]
crons = [
  "0 0 * * *",   # Daily at midnight - cleanup expired reports
  "0 1 * * *",  # Daily at 1 AM - aggregate analytics
  "*/5 * * * *",  # Automation dispatcher & queue draining
]

# Observability
[observability]
enabled = true
head_sampling_rate = 0.1

# ============================================
# Production environment
# ============================================
[env.production]
name = "anti-detect-api"

[env.production.vars]
ENVIRONMENT = "production"
CORS_ORIGIN = "https://anti-detect-web.pages.dev"
TURNSTILE_SITE_KEY = "0x4AAAAAAA..."
WEBHOOK_SIGNING_SECRET = "change-me"
API_KEYS = ""

[[env.production.d1_databases]]
binding = "DB"
database_name = "anti-detect"
database_id = "d19c7a11-4ae5-4bef-bd65-05a2133a5371"

[[env.production.kv_namespaces]]
binding = "IP_CACHE"
id = "06d882d1a9a946dbaf6204a542d5df58"

[[env.production.kv_namespaces]]
binding = "JA3_DB"
id = "6a013dac92704342a9f59317eabe956d"

[[env.production.kv_namespaces]]
binding = "RATE_LIMITS"
id = "d8a25b02d2d248e3bdc81e9fd6af67b3"

[[env.production.kv_namespaces]]
binding = "TASK_QUEUE"
id = "4e012345678901234567890123456789"

[[env.production.r2_buckets]]
binding = "R2"
bucket_name = "anti-detect-reports"

# Routes will be added once custom domain is configured
# [[env.production.routes]]
# pattern = "api.anti-detect.com/*"
# zone_name = "anti-detect.com"

# ============================================
# Staging environment
# ============================================
[env.staging]
name = "anti-detect-api-staging"

[env.staging.vars]
ENVIRONMENT = "staging"
CORS_ORIGIN = "https://staging.anti-detect-web.pages.dev"
WEBHOOK_SIGNING_SECRET = "staging-signing-key"
API_KEYS = ""

[[env.staging.d1_databases]]
binding = "DB"
database_name = "anti-detect"
database_id = "d19c7a11-4ae5-4bef-bd65-05a2133a5371"

[[env.staging.kv_namespaces]]
binding = "IP_CACHE"
id = "06d882d1a9a946dbaf6204a542d5df58"

[[env.staging.kv_namespaces]]
binding = "JA3_DB"
id = "6a013dac92704342a9f59317eabe956d"

[[env.staging.kv_namespaces]]
binding = "RATE_LIMITS"
id = "d8a25b02d2d248e3bdc81e9fd6af67b3"

[[env.staging.kv_namespaces]]
binding = "TASK_QUEUE"
id = "4e012345678901234567890123456789"

[[env.staging.r2_buckets]]
binding = "R2"
bucket_name = "anti-detect-reports"

# ============================================
# Development environment
# ============================================
[env.dev]
name = "anti-detect-api-dev"

[env.dev.vars]
ENVIRONMENT = "development"
CORS_ORIGIN = "http://localhost:3000"
WEBHOOK_SIGNING_SECRET = "local-dev-signing-key"
# In development, Turnstile verification is skipped if secret not configured
# Set TURNSTILE_SECRET via wrangler secret put TURNSTILE_SECRET --env dev to enable
